<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Tai Tong's Blog - Uploading files to a LAMP stack and keep track of it with a CMS</title>
  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="alternate" type="application/rss+xml" title="My Blog" href="/rss.xml">
  <link rel="stylesheet" href="/assets/css/highlight.css">
</head>
<body>

  <nav class="main-nav">
    
        <a href='/'> <span class="arrow">←</span> Home </a>
    

    
        
            <a href='/about'>About </a>
        
    
    
     
        
            <a href='/notes'>Notes </a>
        
    
    
    <a class="cta" href="/feed.xml">Subscribe</a>
</nav>

  

  <section id="wrapper" class="">
    <article class="post">
    <header>
        <h1>Uploading files to a LAMP stack and keep track of it with a CMS</h1>
        <h2 class="headline">December 22, 2014</h2>
    </header>
    <section id="post-body">
        <h1 id="uploading-files-to-a-lamp-stack-and-keep-track-of-it-with-a-cms-part-1">Uploading files to a LAMP stack and keep track of it with a CMS Part 1</h1>
<blockquote>

  <h6 id="this-is-technically-a-continuation-of-daves-tutorial-on-how-to-create-a-blog-with-lamp-herehttpsdaveismynamecomcreating-a-blog-from-scratch-with-php-bpva2tvpnviko-and-ive-added-my-own-twist-and-turned-it-into-a-small-cms-by-allowing-users-to-upload-photos-and-keep-track-of-their-uploads-i-will-be-referencing-a-lot-of-the-files-back-to-what-was-created-on-daves-tutorial">This is technically a continuation of Dave’s tutorial on how to create a Blog with LAMP <a href="https://daveismyname.com/creating-a-blog-from-scratch-with-php-bp#.Va2tvpNViko">here</a>, and I’ve added my own twist and turned it into a small CMS by allowing users to upload photos and keep track of their uploads. I will be referencing a lot of the files back to what was created on Dave’s tutorial</h6>
</blockquote>

<p>If we are continuing from the tutorial, we should have a completed admin console that looks like this:</p>

<h3 id="the-upload-script">The upload script</h3>
<p>Lets create the upload script, which will handle the interaction of the post request that has the files attached to it. Along with storing the file we will also add the metadata from the request’s body and store it in the MySQL database</p>

<p>Lets first define a few variables such as the extensions that we will allow for upload, we will define it in an array called $allowedExts. Next we will store the temp file name into an array that is done by parsing the period before the extesnion using the explode command, so we will define it in $temp. Our extension will naturally use the the end of the array assuming the file was named correctly to store the extension of the file, we will define this use $extension. From the request we will assume the form will also contain an title and description field which we will parse from the request body. I’ve defined the two with $imgTitle and $imgeDesc.</p>

<blockquote>
  <p>Your variables should look like this</p>
</blockquote>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">		<span class="vg">$allowedExts</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">"gif"</span><span class="p">,</span> <span class="s2">"jpeg"</span><span class="p">,</span> <span class="s2">"jpg"</span><span class="p">,</span> <span class="s2">"png"</span><span class="p">);</span>
		<span class="vg">$temp</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
		<span class="vg">$extension</span> <span class="o">=</span> <span class="k">end</span><span class="p">(</span><span class="vg">$temp</span><span class="p">);</span>
		<span class="vg">$imgTitle</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="p">[</span><span class="s1">'imgTitle'</span><span class="p">];</span>
		<span class="vg">$imgDesc</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="p">[</span><span class="s1">'imgDesc'</span><span class="p">];</span></code></pre></figure>

<p>Now that we’ve checked some basic request body information we can now move on to verifying that the file isn’t too large and that the file type from the request header matches one of the cases and the extension is valid and within our $allowedExts array. We will require a title for every image file that is uploaded so we will print an error if the title is missing.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17</pre></td><td class="code"><pre><span class="n">echo</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200000000</span><span class="p">){</span>
	<span class="n">echo</span> <span class="s2">"File is too large"</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">echo</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(((</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/gif"</span><span class="p">)</span>
<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/jpeg"</span><span class="p">)</span>
<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/jpg"</span><span class="p">)</span>
<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/pjpeg"</span><span class="p">)</span>
<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/x-png"</span><span class="p">)</span>
<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/png"</span><span class="p">))</span>
<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span>
<span class="o">&amp;&amp;</span> <span class="n">in_array</span><span class="p">(</span><span class="vg">$extension</span><span class="p">,</span> <span class="vg">$allowedExts</span><span class="p">))</span> <span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="vg">$imgTitle</span> <span class="o">==</span> <span class="n">null</span><span class="p">){</span>
	<span class="n">echo</span> <span class="s2">"&lt;p class=</span><span class="se">\"</span><span class="s2">error</span><span class="se">\"</span><span class="s2">&gt; Please Enter a Title&lt;/p&gt;"</span><span class="p">;</span>
	<span class="n">echo</span> <span class="s1">'&lt;a href="javascript:history.go(-1)"&gt;&lt;h2&gt; Go Back &lt;/h2&gt;&lt;/a&gt;'</span><span class="p">;</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>We added to the above code we will now check for any errors that could have occured during the upload, of which we will send back and not continue the upload.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">else</span><span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
	<span class="n">echo</span> <span class="s2">"&lt;p class=</span><span class="se">\"</span><span class="s2">error</span><span class="se">\"</span><span class="s2">&gt;Return Code: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;/p&gt;"</span><span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="k">else</span> <span class="p">{</span>
		<span class="sr">//</span><span class="n">diagnostic</span> <span class="n">comments</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">it</span> <span class="n">uploaded</span>
		<span class="n">echo</span> <span class="s2">"../img/Upload: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
		<span class="n">echo</span> <span class="s2">"Type: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
		<span class="n">echo</span> <span class="s2">"Size: "</span> <span class="o">.</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">.</span> <span class="s2">" kB&lt;br&gt;"</span><span class="p">;</span>
		<span class="n">echo</span> <span class="s2">"Temp file: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
		
		<span class="sr">//i</span><span class="n">f</span> <span class="n">the</span> <span class="n">file</span> <span class="n">exists</span> <span class="n">already</span> <span class="n">within</span> <span class="n">the</span> <span class="n">upload</span> <span class="n">directory</span> <span class="n">we</span> <span class="n">will</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">upload</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="s2">"../img/upload/"</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">echo</span> <span class="s2">"&lt;p class=</span><span class="se">\"</span><span class="s2">error</span><span class="se">\"</span><span class="s2">&gt;"</span><span class="o">.</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">" already exists&lt;/p&gt; "</span><span class="p">;</span>
		<span class="p">}</span></code></pre></figure>

<p>After the file has gone through our extensive verification we can finally move on to the most crucial step of the file upload, which is to move the file from the temporary folder to the permenant folder in /img/upload. We accomplish this using the move_upload_file command. We will also be using parameterized sql statements to store and track the uploaded files. The MySQL database will hold the title, description, and the file path.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">	
				<span class="k">else</span> <span class="p">{</span>
				<span class="n">move_uploaded_file</span><span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span>
				<span class="s2">"../img/upload/"</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
				<span class="n">echo</span> <span class="s2">"Stored in: "</span> <span class="o">.</span> <span class="s2">"../img/upload/"</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isset</span><span class="p">(</span><span class="vg">$error</span><span class="p">)){</span>
					<span class="n">try</span> <span class="p">{</span>
						<span class="sr">//</span><span class="n">creates</span> <span class="n">the</span> <span class="n">file</span> <span class="n">path</span> <span class="n">to</span> <span class="n">store</span> <span class="k">in</span> <span class="n">the</span> <span class="n">database</span>
						<span class="vg">$path</span> <span class="o">=</span> <span class="s2">"/img/upload/"</span><span class="o">.</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
						
						<span class="sr">//inse</span><span class="n">rt</span> <span class="n">into</span> <span class="n">database</span>
						<span class="vg">$stmt</span> <span class="o">=</span> <span class="vg">$db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO picture_directory (imgTitle,imgDesc,imgPath) VALUES ( :imgTitle, :imgDesc, :imgPath)'</span><span class="p">)</span> <span class="p">;</span>
						<span class="vg">$stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">array</span><span class="p">(</span>
							<span class="s1">':imgTitle'</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgTitle</span><span class="p">),</span>
							<span class="s1">':imgDesc'</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgDesc</span><span class="p">),</span>
							<span class="s1">':imgPath'</span> <span class="o">=&gt;</span> <span class="vg">$path</span>
						<span class="p">));</span>
						
						<span class="sr">//</span><span class="n">redirect</span> <span class="n">to</span> <span class="n">index</span> <span class="n">page</span>
						<span class="n">header</span><span class="p">(</span><span class="s1">'Location: imageupload.php?action=added'</span><span class="p">);</span>
						<span class="nb">exit</span><span class="p">;</span>
					<span class="p">}</span> <span class="kp">catch</span><span class="p">(</span><span class="no">PDOException</span> <span class="vg">$e</span><span class="p">)</span> <span class="p">{</span>
					    <span class="n">echo</span> <span class="vg">$e</span><span class="o">-&gt;</span><span class="n">getMessage</span><span class="p">();</span>
					<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> 
	<span class="p">}</span><span class="sc">?&gt;</span></code></pre></figure>

<p>The end script should look something like this with the authentication and included header files for styling</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="sr">//in</span><span class="n">clude</span> <span class="n">config</span>
<span class="n">require_once</span><span class="p">(</span><span class="s1">'../includes/config.php'</span><span class="p">);</span>
<span class="sr">//i</span><span class="n">f</span> <span class="n">not</span> <span class="n">logged</span> <span class="k">in</span> <span class="n">redirect</span> <span class="n">to</span> <span class="n">login</span> <span class="n">page</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="vg">$user</span><span class="o">-&gt;</span><span class="n">is_logged_in</span><span class="p">()){</span> <span class="n">header</span><span class="p">(</span><span class="s1">'Location: login.php'</span><span class="p">);</span> <span class="p">}</span>
<span class="sc">?&gt;</span>
<span class="o">&lt;!</span><span class="n">doctype</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">"utf-8"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="no">Admin</span> <span class="o">-</span> <span class="no">Image</span> <span class="no">Upload</span> <span class="no">Script</span><span class="o">&lt;</span><span class="sr">/title&gt;
  &lt;?php include('imports.php'); ?&gt;
&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"wrapper"</span><span class="o">&gt;</span>

	<span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="kp">include</span><span class="p">(</span><span class="s1">'menu.php'</span><span class="p">);</span><span class="sc">?&gt;</span>
		<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">"imageupload.php"</span><span class="o">&gt;</span><span class="no">Images</span> <span class="no">Index</span><span class="o">&lt;</span><span class="sr">/a&gt;&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
	<span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> 
		<span class="vg">$allowedExts</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">"gif"</span><span class="p">,</span> <span class="s2">"jpeg"</span><span class="p">,</span> <span class="s2">"jpg"</span><span class="p">,</span> <span class="s2">"png"</span><span class="p">);</span>
		<span class="vg">$temp</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
		<span class="vg">$extension</span> <span class="o">=</span> <span class="k">end</span><span class="p">(</span><span class="vg">$temp</span><span class="p">);</span>
		<span class="vg">$imgTitle</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="p">[</span><span class="s1">'imgTitle'</span><span class="p">];</span>
		<span class="vg">$imgDesc</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="p">[</span><span class="s1">'imgDesc'</span><span class="p">];</span>

		<span class="n">echo</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">];</span>
		<span class="k">if</span><span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200000000</span><span class="p">){</span>
			<span class="n">echo</span> <span class="s2">"File is too large"</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">echo</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(((</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/gif"</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/jpeg"</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/jpg"</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/pjpeg"</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/x-png"</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"image/png"</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">in_array</span><span class="p">(</span><span class="vg">$extension</span><span class="p">,</span> <span class="vg">$allowedExts</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="vg">$imgTitle</span> <span class="o">==</span> <span class="n">null</span><span class="p">){</span>
			<span class="n">echo</span> <span class="s2">"&lt;p class=</span><span class="se">\"</span><span class="s2">error</span><span class="se">\"</span><span class="s2">&gt; Please Enter a Title&lt;/p&gt;"</span><span class="p">;</span>
			<span class="n">echo</span> <span class="s1">'&lt;a href="javascript:history.go(-1)"&gt;&lt;h2&gt; Go Back &lt;/h2&gt;&lt;/a&gt;'</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">echo</span> <span class="s2">"&lt;p class=</span><span class="se">\"</span><span class="s2">error</span><span class="se">\"</span><span class="s2">&gt;Return Code: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"error"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;/p&gt;"</span><span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
			<span class="p">}</span> 
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">echo</span> <span class="s2">"../img/Upload: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
				<span class="n">echo</span> <span class="s2">"Type: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
				<span class="n">echo</span> <span class="s2">"Size: "</span> <span class="o">.</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">.</span> <span class="s2">" kB&lt;br&gt;"</span><span class="p">;</span>
				<span class="n">echo</span> <span class="s2">"Temp file: "</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="s2">"../img/upload/"</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">echo</span> <span class="s2">"&lt;p class=</span><span class="se">\"</span><span class="s2">error</span><span class="se">\"</span><span class="s2">&gt;"</span><span class="o">.</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">.</span> <span class="s2">" already exists&lt;/p&gt; "</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
				<span class="n">move_uploaded_file</span><span class="p">(</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span>
				<span class="s2">"../img/upload/"</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">]);</span>
				<span class="n">echo</span> <span class="s2">"Stored in: "</span> <span class="o">.</span> <span class="s2">"../img/upload/"</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isset</span><span class="p">(</span><span class="vg">$error</span><span class="p">)){</span>
					<span class="n">try</span> <span class="p">{</span>
						<span class="vg">$path</span> <span class="o">=</span> <span class="s2">"/img/upload/"</span><span class="o">.</span><span class="vg">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
						
						<span class="sr">//inse</span><span class="n">rt</span> <span class="n">into</span> <span class="n">database</span>
						<span class="vg">$stmt</span> <span class="o">=</span> <span class="vg">$db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s1">'INSERT INTO picture_directory (imgTitle,imgDesc,imgPath) VALUES ( :imgTitle, :imgDesc, :imgPath)'</span><span class="p">)</span> <span class="p">;</span>
						<span class="vg">$stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">array</span><span class="p">(</span>
							<span class="s1">':imgTitle'</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgTitle</span><span class="p">),</span>
							<span class="s1">':imgDesc'</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgDesc</span><span class="p">),</span>
							<span class="s1">':imgPath'</span> <span class="o">=&gt;</span> <span class="vg">$path</span>
						<span class="p">));</span>
						
						<span class="sr">//</span><span class="n">redirect</span> <span class="n">to</span> <span class="n">index</span> <span class="n">page</span>
						<span class="n">header</span><span class="p">(</span><span class="s1">'Location: imageupload.php?action=added'</span><span class="p">);</span>
						<span class="nb">exit</span><span class="p">;</span>
					<span class="p">}</span> <span class="kp">catch</span><span class="p">(</span><span class="no">PDOException</span> <span class="vg">$e</span><span class="p">)</span> <span class="p">{</span>
					    <span class="n">echo</span> <span class="vg">$e</span><span class="o">-&gt;</span><span class="n">getMessage</span><span class="p">();</span>
					<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> 
	<span class="p">}</span><span class="sc">?&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;
&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/html&gt;</span></code></pre></figure>

    </section>
</article>
<footer id="post-meta" class="clearfix">
    <a href="http://twitter.com/TaiRTong">
        <img class="avatar" src="/assets/images/avatar.png">
        <div>
            <span class="dark">Tai Tong</span>
            <span>Blog about everything from coding to anything I find interesting.</span>
        </div>
    </a>

    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=//2014/uploading-to-php/ - Uploading files to a LAMP stack and keep track of it with a CMS by @TaiRTong"><span class="icon-twitter"> Tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>
    </section>
</footer>

<!-- Disqus comments -->


<!-- Archive post list -->





  </section>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/highlight.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54598212-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>



