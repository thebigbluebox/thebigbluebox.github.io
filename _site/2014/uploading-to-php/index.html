<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Tai Tong's Blog - Uploading files to a LAMP stack and keep track of it with a CMS</title>
  <link rel="shortcut icon" href="/assets/images/favicon.ico">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="alternate" type="application/rss+xml" title="My Blog" href="/rss.xml">
  <link rel="stylesheet" href="/assets/css/highlight.css">
</head>
<body>

  <nav class="main-nav">
    
        <a href='/'> <span class="arrow">←</span> Home </a>
    

    
        
            <a href='/about'>About </a>
        
    
    
     
        
            <a href='/notes'>Notes </a>
        
    
    
    <a class="cta" href="/feed.xml">Subscribe</a>
</nav>

  

  <section id="wrapper" class="">
    <article class="post">
    <header>
        <h1>Uploading files to a LAMP stack and keep track of it with a CMS</h1>
        <h2 class="headline">December 22, 2014</h2>
    </header>
    <section id="post-body">
        <h1 id="uploading-files-to-a-lamp-stack-and-keep-track-of-it-with-a-cms-part-1">Uploading files to a LAMP stack and keep track of it with a CMS Part 1</h1>
<blockquote>

  <h6 id="this-is-technically-a-continuation-of-daves-tutorial-on-how-to-create-a-blog-with-lamp-herehttpsdaveismynamecomcreating-a-blog-from-scratch-with-php-bpva2tvpnviko-and-ive-added-my-own-twist-and-turned-it-into-a-small-cms-by-allowing-users-to-upload-photos-and-keep-track-of-their-uploads-i-will-be-referencing-a-lot-of-the-files-back-to-what-was-created-on-daves-tutorial">This is technically a continuation of Dave’s tutorial on how to create a Blog with LAMP <a href="https://daveismyname.com/creating-a-blog-from-scratch-with-php-bp#.Va2tvpNViko">here</a>, and I’ve added my own twist and turned it into a small CMS by allowing users to upload photos and keep track of their uploads. I will be referencing a lot of the files back to what was created on Dave’s tutorial</h6>
</blockquote>

<p>If we are continuing from the tutorial, we should have a completed admin console that looks like this:</p>

<h3 id="the-upload-script">The upload script</h3>
<p>Lets create the upload script, which will handle the interaction of the post request that has the files attached to it. Along with storing the file we will also add the metadata from the request’s body and store it in the MySQL database</p>

<p>Lets first define a few variables such as the extensions that we will allow for upload, we will define it in an array called $allowedExts. Next we will store the temp file name into an array that is done by parsing the period before the extesnion using the explode command, so we will define it in $temp. Our extension will naturally use the the end of the array assuming the file was named correctly to store the extension of the file, we will define this use $extension. From the request we will assume the form will also contain an title and description field which we will parse from the request body. I’ve defined the two with $imgTitle and $imgeDesc.</p>

<blockquote>
  <p>Your variables should look like this</p>
</blockquote>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="vg">$allowedExts</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;gif&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">);</span>
		<span class="vg">$temp</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">);</span>
		<span class="vg">$extension</span> <span class="o">=</span> <span class="k">end</span><span class="p">(</span><span class="vg">$temp</span><span class="p">);</span>
		<span class="vg">$imgTitle</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="o">[</span><span class="s1">&#39;imgTitle&#39;</span><span class="o">]</span><span class="p">;</span>
		<span class="vg">$imgDesc</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="o">[</span><span class="s1">&#39;imgDesc&#39;</span><span class="o">]</span><span class="p">;</span></code></pre></div>

<p>Now that we’ve checked some basic request body information we can now move on to verifying that the file isn’t too large and that the file type from the request header matches one of the cases and the extension is valid and within our $allowedExts array. We will require a title for every image file that is uploaded so we will print an error if the title is missing.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="lineno"> 1</span> <span class="n">echo</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span><span class="p">;</span>
<span class="lineno"> 2</span> <span class="k">if</span><span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span> <span class="o">&gt;</span> <span class="mi">200000000</span><span class="p">){</span>
<span class="lineno"> 3</span> 	<span class="n">echo</span> <span class="s2">&quot;File is too large&quot;</span><span class="p">;</span>
<span class="lineno"> 4</span> <span class="p">}</span>
<span class="lineno"> 5</span> <span class="n">echo</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span><span class="p">;</span>
<span class="lineno"> 6</span> <span class="k">if</span> <span class="p">(((</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">)</span>
<span class="lineno"> 7</span> <span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">)</span>
<span class="lineno"> 8</span> <span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/jpg&quot;</span><span class="p">)</span>
<span class="lineno"> 9</span> <span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/pjpeg&quot;</span><span class="p">)</span>
<span class="lineno">10</span> <span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/x-png&quot;</span><span class="p">)</span>
<span class="lineno">11</span> <span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/png&quot;</span><span class="p">))</span>
<span class="lineno">12</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span>
<span class="lineno">13</span> <span class="o">&amp;&amp;</span> <span class="n">in_array</span><span class="p">(</span><span class="vg">$extension</span><span class="p">,</span> <span class="vg">$allowedExts</span><span class="p">))</span> <span class="p">{</span>
<span class="lineno">14</span> <span class="k">if</span><span class="p">(</span><span class="vg">$imgTitle</span> <span class="o">==</span> <span class="n">null</span><span class="p">){</span>
<span class="lineno">15</span> 	<span class="n">echo</span> <span class="s2">&quot;&lt;p class=</span><span class="se">\&quot;</span><span class="s2">error</span><span class="se">\&quot;</span><span class="s2">&gt; Please Enter a Title&lt;/p&gt;&quot;</span><span class="p">;</span>
<span class="lineno">16</span> 	<span class="n">echo</span> <span class="s1">&#39;&lt;a href=&quot;javascript:history.go(-1)&quot;&gt;&lt;h2&gt; Go Back &lt;/h2&gt;&lt;/a&gt;&#39;</span><span class="p">;</span>
<span class="lineno">17</span> <span class="p">}</span></code></pre></div>

<p>We added to the above code we will now check for any errors that could have occured during the upload, of which we will send back and not continue the upload.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">else</span><span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;error&quot;</span><span class="o">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
	<span class="n">echo</span> <span class="s2">&quot;&lt;p class=</span><span class="se">\&quot;</span><span class="s2">error</span><span class="se">\&quot;</span><span class="s2">&gt;Return Code: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;error&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="k">else</span> <span class="p">{</span>
		<span class="sr">//</span><span class="n">diagnostic</span> <span class="n">comments</span> <span class="n">to</span> <span class="n">make</span> <span class="n">sure</span> <span class="n">it</span> <span class="n">uploaded</span>
		<span class="n">echo</span> <span class="s2">&quot;../img/Upload: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
		<span class="n">echo</span> <span class="s2">&quot;Type: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
		<span class="n">echo</span> <span class="s2">&quot;Size: &quot;</span> <span class="o">.</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; kB&lt;br&gt;&quot;</span><span class="p">;</span>
		<span class="n">echo</span> <span class="s2">&quot;Temp file: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;tmp_name&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
		
		<span class="sr">//i</span><span class="n">f</span> <span class="n">the</span> <span class="n">file</span> <span class="n">exists</span> <span class="n">already</span> <span class="n">within</span> <span class="n">the</span> <span class="n">upload</span> <span class="n">directory</span> <span class="n">we</span> <span class="n">will</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">upload</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="s2">&quot;../img/upload/&quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">echo</span> <span class="s2">&quot;&lt;p class=</span><span class="se">\&quot;</span><span class="s2">error</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot; already exists&lt;/p&gt; &quot;</span><span class="p">;</span>
		<span class="p">}</span></code></pre></div>

<p>After the file has gone through our extensive verification we can finally move on to the most crucial step of the file upload, which is to move the file from the temporary folder to the permenant folder in /img/upload. We accomplish this using the move_upload_file command. We will also be using parameterized sql statements to store and track the uploaded files. The MySQL database will hold the title, description, and the file path.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">else</span> <span class="p">{</span>
				<span class="n">move_uploaded_file</span><span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;tmp_name&quot;</span><span class="o">]</span><span class="p">,</span>
				<span class="s2">&quot;../img/upload/&quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">);</span>
				<span class="n">echo</span> <span class="s2">&quot;Stored in: &quot;</span> <span class="o">.</span> <span class="s2">&quot;../img/upload/&quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isset</span><span class="p">(</span><span class="vg">$error</span><span class="p">)){</span>
					<span class="n">try</span> <span class="p">{</span>
						<span class="sr">//</span><span class="n">creates</span> <span class="n">the</span> <span class="n">file</span> <span class="n">path</span> <span class="n">to</span> <span class="n">store</span> <span class="k">in</span> <span class="n">the</span> <span class="n">database</span>
						<span class="vg">$path</span> <span class="o">=</span> <span class="s2">&quot;/img/upload/&quot;</span><span class="o">.</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">;</span>
						
						<span class="sr">//inse</span><span class="n">rt</span> <span class="n">into</span> <span class="n">database</span>
						<span class="vg">$stmt</span> <span class="o">=</span> <span class="vg">$db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s1">&#39;INSERT INTO picture_directory (imgTitle,imgDesc,imgPath) VALUES ( :imgTitle, :imgDesc, :imgPath)&#39;</span><span class="p">)</span> <span class="p">;</span>
						<span class="vg">$stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">array</span><span class="p">(</span>
							<span class="s1">&#39;:imgTitle&#39;</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgTitle</span><span class="p">),</span>
							<span class="s1">&#39;:imgDesc&#39;</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgDesc</span><span class="p">),</span>
							<span class="s1">&#39;:imgPath&#39;</span> <span class="o">=&gt;</span> <span class="vg">$path</span>
						<span class="p">));</span>
						
						<span class="sr">//</span><span class="n">redirect</span> <span class="n">to</span> <span class="n">index</span> <span class="n">page</span>
						<span class="n">header</span><span class="p">(</span><span class="s1">&#39;Location: imageupload.php?action=added&#39;</span><span class="p">);</span>
						<span class="nb">exit</span><span class="p">;</span>
					<span class="p">}</span> <span class="kp">catch</span><span class="p">(</span><span class="no">PDOException</span> <span class="vg">$e</span><span class="p">)</span> <span class="p">{</span>
					    <span class="n">echo</span> <span class="vg">$e</span><span class="o">-&gt;</span><span class="n">getMessage</span><span class="p">();</span>
					<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> 
	<span class="p">}</span><span class="sc">?&gt;</span></code></pre></div>

<p>The end script should look something like this with the authentication and included header files for styling</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="sr">//in</span><span class="n">clude</span> <span class="n">config</span>
<span class="n">require_once</span><span class="p">(</span><span class="s1">&#39;../includes/config.php&#39;</span><span class="p">);</span>
<span class="sr">//i</span><span class="n">f</span> <span class="ow">not</span> <span class="n">logged</span> <span class="k">in</span> <span class="n">redirect</span> <span class="n">to</span> <span class="n">login</span> <span class="n">page</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="vg">$user</span><span class="o">-&gt;</span><span class="n">is_logged_in</span><span class="p">()){</span> <span class="n">header</span><span class="p">(</span><span class="s1">&#39;Location: login.php&#39;</span><span class="p">);</span> <span class="p">}</span>
<span class="sc">?&gt;</span>
<span class="o">&lt;!</span><span class="n">doctype</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&quot;en&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="no">Admin</span> <span class="o">-</span> <span class="no">Image</span> <span class="no">Upload</span> <span class="no">Script</span><span class="o">&lt;</span><span class="sr">/title&gt;</span>
<span class="sr">  &lt;?php include(&#39;imports.php&#39;); ?&gt;</span>
<span class="sr">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">div</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;wrapper&quot;</span><span class="o">&gt;</span>

	<span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> <span class="kp">include</span><span class="p">(</span><span class="s1">&#39;menu.php&#39;</span><span class="p">);</span><span class="sc">?&gt;</span>
		<span class="o">&lt;</span><span class="nb">p</span><span class="o">&gt;&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;imageupload.php&quot;</span><span class="o">&gt;</span><span class="no">Images</span> <span class="no">Index</span><span class="o">&lt;</span><span class="sr">/a&gt;&lt;/</span><span class="nb">p</span><span class="o">&gt;</span>
	<span class="o">&lt;</span><span class="p">?</span><span class="n">php</span> 
		<span class="vg">$allowedExts</span> <span class="o">=</span> <span class="n">array</span><span class="p">(</span><span class="s2">&quot;gif&quot;</span><span class="p">,</span> <span class="s2">&quot;jpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">);</span>
		<span class="vg">$temp</span> <span class="o">=</span> <span class="n">explode</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">);</span>
		<span class="vg">$extension</span> <span class="o">=</span> <span class="k">end</span><span class="p">(</span><span class="vg">$temp</span><span class="p">);</span>
		<span class="vg">$imgTitle</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="o">[</span><span class="s1">&#39;imgTitle&#39;</span><span class="o">]</span><span class="p">;</span>
		<span class="vg">$imgDesc</span> <span class="o">=</span> <span class="vg">$_POST</span><span class="o">[</span><span class="s1">&#39;imgDesc&#39;</span><span class="o">]</span><span class="p">;</span>

		<span class="n">echo</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span> <span class="o">&gt;</span> <span class="mi">200000000</span><span class="p">){</span>
			<span class="n">echo</span> <span class="s2">&quot;File is too large&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">echo</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/jpg&quot;</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/pjpeg&quot;</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/x-png&quot;</span><span class="p">)</span>
		<span class="o">||</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;image/png&quot;</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span> <span class="o">&lt;</span> <span class="mi">200000000</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span> <span class="n">in_array</span><span class="p">(</span><span class="vg">$extension</span><span class="p">,</span> <span class="vg">$allowedExts</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="vg">$imgTitle</span> <span class="o">==</span> <span class="n">null</span><span class="p">){</span>
			<span class="n">echo</span> <span class="s2">&quot;&lt;p class=</span><span class="se">\&quot;</span><span class="s2">error</span><span class="se">\&quot;</span><span class="s2">&gt; Please Enter a Title&lt;/p&gt;&quot;</span><span class="p">;</span>
			<span class="n">echo</span> <span class="s1">&#39;&lt;a href=&quot;javascript:history.go(-1)&quot;&gt;&lt;h2&gt; Go Back &lt;/h2&gt;&lt;/a&gt;&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span><span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;error&quot;</span><span class="o">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">echo</span> <span class="s2">&quot;&lt;p class=</span><span class="se">\&quot;</span><span class="s2">error</span><span class="se">\&quot;</span><span class="s2">&gt;Return Code: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;error&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
			<span class="p">}</span> 
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">echo</span> <span class="s2">&quot;../img/Upload: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
				<span class="n">echo</span> <span class="s2">&quot;Type: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;type&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
				<span class="n">echo</span> <span class="s2">&quot;Size: &quot;</span> <span class="o">.</span> <span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;size&quot;</span><span class="o">]</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">.</span> <span class="s2">&quot; kB&lt;br&gt;&quot;</span><span class="p">;</span>
				<span class="n">echo</span> <span class="s2">&quot;Temp file: &quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;tmp_name&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">file_exists</span><span class="p">(</span><span class="s2">&quot;../img/upload/&quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">echo</span> <span class="s2">&quot;&lt;p class=</span><span class="se">\&quot;</span><span class="s2">error</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span> <span class="o">.</span> <span class="s2">&quot; already exists&lt;/p&gt; &quot;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
				<span class="n">move_uploaded_file</span><span class="p">(</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;tmp_name&quot;</span><span class="o">]</span><span class="p">,</span>
				<span class="s2">&quot;../img/upload/&quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">);</span>
				<span class="n">echo</span> <span class="s2">&quot;Stored in: &quot;</span> <span class="o">.</span> <span class="s2">&quot;../img/upload/&quot;</span> <span class="o">.</span> <span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">;</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isset</span><span class="p">(</span><span class="vg">$error</span><span class="p">)){</span>
					<span class="n">try</span> <span class="p">{</span>
						<span class="vg">$path</span> <span class="o">=</span> <span class="s2">&quot;/img/upload/&quot;</span><span class="o">.</span><span class="vg">$_FILES</span><span class="o">[</span><span class="s2">&quot;file&quot;</span><span class="o">][</span><span class="s2">&quot;name&quot;</span><span class="o">]</span><span class="p">;</span>
						
						<span class="sr">//inse</span><span class="n">rt</span> <span class="n">into</span> <span class="n">database</span>
						<span class="vg">$stmt</span> <span class="o">=</span> <span class="vg">$db</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s1">&#39;INSERT INTO picture_directory (imgTitle,imgDesc,imgPath) VALUES ( :imgTitle, :imgDesc, :imgPath)&#39;</span><span class="p">)</span> <span class="p">;</span>
						<span class="vg">$stmt</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="n">array</span><span class="p">(</span>
							<span class="s1">&#39;:imgTitle&#39;</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgTitle</span><span class="p">),</span>
							<span class="s1">&#39;:imgDesc&#39;</span> <span class="o">=&gt;</span> <span class="n">htmlspecialchars</span><span class="p">(</span><span class="vg">$imgDesc</span><span class="p">),</span>
							<span class="s1">&#39;:imgPath&#39;</span> <span class="o">=&gt;</span> <span class="vg">$path</span>
						<span class="p">));</span>
						
						<span class="sr">//</span><span class="n">redirect</span> <span class="n">to</span> <span class="n">index</span> <span class="n">page</span>
						<span class="n">header</span><span class="p">(</span><span class="s1">&#39;Location: imageupload.php?action=added&#39;</span><span class="p">);</span>
						<span class="nb">exit</span><span class="p">;</span>
					<span class="p">}</span> <span class="kp">catch</span><span class="p">(</span><span class="no">PDOException</span> <span class="vg">$e</span><span class="p">)</span> <span class="p">{</span>
					    <span class="n">echo</span> <span class="vg">$e</span><span class="o">-&gt;</span><span class="n">getMessage</span><span class="p">();</span>
					<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> 
	<span class="p">}</span><span class="sc">?&gt;</span>
<span class="o">&lt;</span><span class="sr">/div&gt;</span>
<span class="sr">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="sr">/html&gt;</span></code></pre></div>

    </section>
</article>
<footer id="post-meta" class="clearfix">
    <a href="http://twitter.com/TaiRTong">
        <img class="avatar" src="/assets/images/avatar.png">
        <div>
            <span class="dark">Tai Tong</span>
            <span>Blog about everything from coding to anything I find interesting.</span>
        </div>
    </a>

    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=//2014/uploading-to-php/ - Uploading files to a LAMP stack and keep track of it with a CMS by @TaiRTong"><span class="icon-twitter"> Tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>
    </section>
</footer>

<!-- Disqus comments -->

    <div class="archive readmore">
        <h3>Comments</h3>
        <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'theperfectsquareca';
        var disqus_developer = 0; // developer mode is on
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
    </div>


<!-- Archive post list -->

    <ul id="post-list" class="archive readmore">
        <h3>Read more</h3>
        
            <li>
                <a href="/2016/New-Notes-Page/">New Notes Page!<aside class="dates">Jan 28</aside></a>
            </li>
        
            <li>
                <a href="/2016/Hackathons-Culture/">Hackathon Culture<aside class="dates">Jan 28</aside></a>
            </li>
        
            <li>
                <a href="/2015/Winning-MHacks-With-JobChoice/">JobChoice and Winning best in Data Analytics in MHacks<aside class="dates">Sep 22</aside></a>
            </li>
        
            <li>
                <a href="/2015/streographic-opengl/">Streographic OpenGL Setup<aside class="dates">Jan 04</aside></a>
            </li>
        
            <li>
                <a href="/2014/uploading-to-php-2/">Uploading files to a LAMP stack and keep track of it with a CMS Part 2<aside class="dates">Dec 23</aside></a>
            </li>
        
            <li>
                <a href="/2014/uploading-to-php/">Uploading files to a LAMP stack and keep track of it with a CMS<aside class="dates">Dec 22</aside></a>
            </li>
        
            <li>
                <a href="/2014/Vigenere-Cipher/">Vignere Cipher<aside class="dates">Dec 10</aside></a>
            </li>
        
    </ul>





  </section>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/highlight.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54598212-3', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>



